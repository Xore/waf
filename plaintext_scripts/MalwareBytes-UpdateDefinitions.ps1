#Requires -Version 5.1

<#
.SYNOPSIS
    Updates Malwarebytes antimalware definitions to the latest version.

.DESCRIPTION
    This script triggers a Malwarebytes definition update by executing the Malwarebytes command-line
    utility. It ensures the system has the latest malware signatures for effective threat detection
    and removal.
    
    Regular definition updates are critical for maintaining protection against emerging threats.
    This script can be scheduled to ensure definitions stay current.

.PARAMETER WaitForCompletion
    If specified, waits for the update process to complete before exiting. Default: True

.PARAMETER TimeoutMinutes
    Maximum number of minutes to wait for update completion. Default: 10

.PARAMETER SaveToCustomField
    Name of a custom field to save the update result status.

.EXAMPLE
    No Parameters

    [Info] Updating Malwarebytes definitions...
    [Info] Update command executed successfully
    [Info] Definitions updated to latest version

.EXAMPLE
    -TimeoutMinutes 5 -SaveToCustomField "MBUpdateStatus"

    [Info] Updating Malwarebytes definitions...
    [Info] Waiting up to 5 minutes for completion...
    [Info] Update completed successfully
    [Info] Status saved to custom field 'MBUpdateStatus'

.OUTPUTS
    None

.NOTES
    Minimum OS Architecture Supported: Windows 10, Windows Server 2016
    Release notes: Initial release for WAF v3.0
    Requires: Malwarebytes installed
    
.COMPONENT
    mbamservice.exe - Malwarebytes command-line service utility
    
.LINK
    https://www.malwarebytes.com/

.FUNCTIONALITY
    - Locates Malwarebytes installation
    - Executes definition update command
    - Waits for update completion with timeout
    - Verifies update success
    - Can save update status to custom fields
    - Handles missing installation gracefully
#>

[CmdletBinding()]
param(
    [switch]$WaitForCompletion = $true,
    [int]$TimeoutMinutes = 10,
    [string]$SaveToCustomField
)

begin {
    if ($env:waitForCompletion -eq "false") {
        $WaitForCompletion = $false
    }
    if ($env:timeoutMinutes -and $env:timeoutMinutes -notlike "null") {
        $TimeoutMinutes = [int]$env:timeoutMinutes
    }
    if ($env:saveToCustomField -and $env:saveToCustomField -notlike "null") {
        $SaveToCustomField = $env:saveToCustomField
    }

    function Set-NinjaProperty {
        [CmdletBinding()]
        Param(
            [Parameter(Mandatory = $True)]
            [String]$Name,
            [Parameter(Mandatory = $True, ValueFromPipeline = $True)]
            $Value
        )
        $NinjaValue = $Value
        $CustomField = $NinjaValue | Ninja-Property-Set-Piped -Name $Name 2>&1
        if ($CustomField.Exception) {
            throw $CustomField
        }
    }

    $ExitCode = 0
}

process {
    try {
        Write-Host "[Info] Updating Malwarebytes definitions..."
        
        $MBPaths = @(
            "$env:ProgramFiles\Malwarebytes\Anti-Malware\mbamservice.exe",
            "${env:ProgramFiles(x86)}\Malwarebytes\Anti-Malware\mbamservice.exe",
            "$env:ProgramFiles\Malwarebytes Anti-Malware\mbamservice.exe",
            "${env:ProgramFiles(x86)}\Malwarebytes Anti-Malware\mbamservice.exe"
        )

        $MBService = $null
        foreach ($Path in $MBPaths) {
            if (Test-Path $Path) {
                $MBService = $Path
                break
            }
        }

        if (-not $MBService) {
            Write-Host "[Error] Malwarebytes installation not found"
            exit 1
        }

        Write-Host "[Info] Found Malwarebytes at: $MBService"

        $UpdateArgs = @("/update")
        
        if ($WaitForCompletion) {
            Write-Host "[Info] Waiting up to $TimeoutMinutes minutes for completion..."
            $Process = Start-Process -FilePath $MBService -ArgumentList $UpdateArgs -Wait -PassThru -NoNewWindow -ErrorAction Stop
            
            if ($Process.ExitCode -eq 0) {
                Write-Host "[Info] Update completed successfully"
                $Status = "Success"
            }
            else {
                Write-Host "[Error] Update failed with exit code: $($Process.ExitCode)"
                $Status = "Failed"
                $ExitCode = 1
            }
        }
        else {
            Start-Process -FilePath $MBService -ArgumentList $UpdateArgs -NoNewWindow -ErrorAction Stop
            Write-Host "[Info] Update command executed successfully"
            $Status = "Initiated"
        }

        if ($SaveToCustomField) {
            try {
                $Status | Set-NinjaProperty -Name $SaveToCustomField
                Write-Host "[Info] Status saved to custom field '$SaveToCustomField'"
            }
            catch {
                Write-Host "[Error] Failed to save to custom field: $_"
                $ExitCode = 1
            }
        }
    }
    catch {
        Write-Host "[Error] Failed to update Malwarebytes definitions: $_"
        $ExitCode = 1
    }

    exit $ExitCode
}

end {
}
